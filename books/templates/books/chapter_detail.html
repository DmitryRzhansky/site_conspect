{% extends "main/base.html" %}
{% load static %}
{% load markdown_extras %}
{% load slugify_extras %}


{% block title %}{{ book.title }} — Глава {{ chapter.number }}: {{ chapter.title }}{% endblock %}

{% block content %}
<h2>{{ book.title }} — Глава {{ chapter.number }}: {{ chapter.title }}</h2>

<div class="page-info">
  Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
  <progress value="{{ page_obj.number }}" max="{{ page_obj.paginator.num_pages }}"></progress>
</div>

<div class="search-bar">
  <input type="text" id="search-input" placeholder="Поиск по странице..." />
  <button onclick="searchInPage()">Найти</button>
</div>

<div class="chapter-content" id="chapter-content">
  {{ page_obj.object_list.0|markdown_highlight|safe }}
</div>

{% if images_on_page %}
<div class="chapter-images-wrapper">
  <h3>Изображения на этой странице:</h3>
  <div class="chapter-images">
    {% for image in images_on_page %}
    <figure>
      <img src="{{ image.image.url }}" alt="{{ image.description }}" />
      {% if image.description %}
      <figcaption>{{ image.description }}</figcaption>
      {% endif %}
    </figure>
    {% endfor %}
  </div>
</div>
{% endif %}

<center><nav class="chapter-pagination">
  {% if page_obj.has_previous %}
  <a href="{% url 'chapter_detail_page' book.id chapter.number page_obj.previous_page_number %}" class="pagination-button">← Предыдущая страница</a>
  {% else %}
  <span class="pagination-button disabled">← Предыдущая страница</span>
  {% endif %}

  {% if page_obj.has_next %}
  <a href="{% url 'chapter_detail_page' book.id chapter.number page_obj.next_page_number %}" class="pagination-button">Следующая страница →</a>
  {% else %}
  <span class="pagination-button disabled">Следующая страница →</span>
  {% endif %}
</nav></center>

<script>
function searchInPage() {
  const input = document.getElementById('search-input').value.toLowerCase();
  const contentDiv = document.getElementById('chapter-content');
  const text = contentDiv.textContent.toLowerCase();

  if (!input) {
    alert('Введите текст для поиска');
    return;
  }

  // Убираем предыдущие подсветки
  const originalHTML = contentDiv.innerHTML;
  contentDiv.innerHTML = originalHTML.replace(/<mark class="search-highlight">([^<]+)<\/mark>/gi, '$1');

  if (!text.includes(input)) {
    alert('Текст не найден');
    return;
  }

  // Подсвечиваем все вхождения
  const regex = new RegExp(input, 'gi');
  contentDiv.innerHTML = contentDiv.innerHTML.replace(regex, (match) => `<mark class="search-highlight">${match}</mark>`);
}
</script>
{% endblock %}
